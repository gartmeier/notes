apiVersion: v1
kind: ConfigMap
metadata:
  name: spring-boot-dashboard
  namespace: monitoring
  labels:
    grafana_dashboard: "1"
data:
  spring-boot.json: |
    {
      "annotations": { "list": [] },
      "description": "Spring Boot / JVM Micrometer Metrics",
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 1,
      "links": [],
      "panels": [
        {
          "title": "Uptime",
          "type": "stat",
          "gridPos": { "h": 4, "w": 4, "x": 0, "y": 0 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": { "defaults": { "unit": "s" }, "overrides": [] },
          "targets": [
            {
              "expr": "process_uptime_seconds{application=\"$application\", instance=\"$instance\"}",
              "legendFormat": ""
            }
          ]
        },
        {
          "title": "Start Time",
          "type": "stat",
          "gridPos": { "h": 4, "w": 4, "x": 4, "y": 0 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": { "defaults": { "unit": "dateTimeAsIso" }, "overrides": [] },
          "targets": [
            {
              "expr": "process_start_time_seconds{application=\"$application\", instance=\"$instance\"} * 1000",
              "legendFormat": ""
            }
          ]
        },
        {
          "title": "CPU Usage",
          "type": "gauge",
          "gridPos": { "h": 4, "w": 4, "x": 8, "y": 0 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": { "defaults": { "unit": "percentunit", "max": 1, "thresholds": { "steps": [{ "value": null, "color": "green" }, { "value": 0.7, "color": "yellow" }, { "value": 0.9, "color": "red" }] } }, "overrides": [] },
          "targets": [
            {
              "expr": "process_cpu_usage{application=\"$application\", instance=\"$instance\"}",
              "legendFormat": ""
            }
          ]
        },
        {
          "title": "JVM Heap Used",
          "type": "gauge",
          "gridPos": { "h": 4, "w": 4, "x": 12, "y": 0 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": { "defaults": { "unit": "bytes", "thresholds": { "steps": [{ "value": null, "color": "green" }, { "value": 0.7, "color": "yellow" }, { "value": 0.9, "color": "red" }] } }, "overrides": [] },
          "targets": [
            {
              "expr": "sum(jvm_memory_used_bytes{application=\"$application\", instance=\"$instance\", area=\"heap\"})",
              "legendFormat": ""
            }
          ]
        },
        {
          "title": "HTTP Request Rate",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 4 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": { "defaults": { "unit": "reqps", "custom": { "fillOpacity": 20 } }, "overrides": [] },
          "targets": [
            {
              "expr": "sum(rate(http_server_requests_seconds_count{application=\"$application\", instance=\"$instance\"}[1m])) by (method, uri, status)",
              "legendFormat": "{{method}} {{uri}} [{{status}}]"
            }
          ]
        },
        {
          "title": "HTTP Response Time (p95)",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 4 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": { "defaults": { "unit": "s", "custom": { "fillOpacity": 20 } }, "overrides": [] },
          "targets": [
            {
              "expr": "histogram_quantile(0.95, sum(rate(http_server_requests_seconds_bucket{application=\"$application\", instance=\"$instance\"}[1m])) by (le, uri))",
              "legendFormat": "{{uri}}"
            }
          ]
        },
        {
          "title": "JVM Heap Memory",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 12 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": { "defaults": { "unit": "bytes", "custom": { "fillOpacity": 20 } }, "overrides": [] },
          "targets": [
            {
              "expr": "sum(jvm_memory_used_bytes{application=\"$application\", instance=\"$instance\", area=\"heap\"}) by (id)",
              "legendFormat": "Used: {{id}}"
            },
            {
              "expr": "sum(jvm_memory_committed_bytes{application=\"$application\", instance=\"$instance\", area=\"heap\"}) by (id)",
              "legendFormat": "Committed: {{id}}"
            },
            {
              "expr": "sum(jvm_memory_max_bytes{application=\"$application\", instance=\"$instance\", area=\"heap\"}) by (id)",
              "legendFormat": "Max: {{id}}"
            }
          ]
        },
        {
          "title": "GC Pause Duration",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 12 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": { "defaults": { "unit": "s", "custom": { "fillOpacity": 20 } }, "overrides": [] },
          "targets": [
            {
              "expr": "rate(jvm_gc_pause_seconds_sum{application=\"$application\", instance=\"$instance\"}[1m])",
              "legendFormat": "{{action}} ({{cause}})"
            }
          ]
        },
        {
          "title": "JVM Threads",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 20 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": { "defaults": { "custom": { "fillOpacity": 20 } }, "overrides": [] },
          "targets": [
            {
              "expr": "jvm_threads_live_threads{application=\"$application\", instance=\"$instance\"}",
              "legendFormat": "Live"
            },
            {
              "expr": "jvm_threads_daemon_threads{application=\"$application\", instance=\"$instance\"}",
              "legendFormat": "Daemon"
            },
            {
              "expr": "jvm_threads_peak_threads{application=\"$application\", instance=\"$instance\"}",
              "legendFormat": "Peak"
            }
          ]
        },
        {
          "title": "JDBC Connection Pool",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 20 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": { "defaults": { "custom": { "fillOpacity": 20 } }, "overrides": [] },
          "targets": [
            {
              "expr": "hikaricp_connections_active{application=\"$application\", instance=\"$instance\"}",
              "legendFormat": "Active"
            },
            {
              "expr": "hikaricp_connections_idle{application=\"$application\", instance=\"$instance\"}",
              "legendFormat": "Idle"
            },
            {
              "expr": "hikaricp_connections_pending{application=\"$application\", instance=\"$instance\"}",
              "legendFormat": "Pending"
            }
          ]
        }
      ],
      "refresh": "10s",
      "schemaVersion": 39,
      "tags": ["spring-boot", "jvm"],
      "templating": {
        "list": [
          {
            "name": "application",
            "type": "query",
            "datasource": { "type": "prometheus", "uid": "prometheus" },
            "definition": "label_values(jvm_memory_used_bytes, application)",
            "includeAll": false,
            "multi": false,
            "refresh": 2,
            "sort": 1
          },
          {
            "name": "instance",
            "type": "query",
            "datasource": { "type": "prometheus", "uid": "prometheus" },
            "definition": "label_values(jvm_memory_used_bytes{application=\"$application\"}, instance)",
            "includeAll": false,
            "multi": false,
            "refresh": 2,
            "sort": 1
          }
        ]
      },
      "time": { "from": "now-1h", "to": "now" },
      "title": "Spring Boot Application",
      "uid": "spring-boot-app"
    }
